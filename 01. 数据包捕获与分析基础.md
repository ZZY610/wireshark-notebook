# 01. 数据包捕获与分析基础

## 网络通信原理
* **协议**是控制两个对等实体进行逻辑通信的**规则**的集合，它定义了通信实体之间交换的报文格式和次序，以及面对报文收发或其他事件时所采取的动作。

### 当我们键入网址时，究竟发生了什么？
* 浏览器首先**解析URL**，确定 Web 服务器和要请求的文件名。然后浏览器生成http请求报文。

* **查询服务器域名对应的 IP 地址**。**DNS**（Domain Name System域名系统） 服务器保存了服务器域名和IP的一一对应关系。
    * 客户端向本地 DNS 服务器（客户端的 TCP/IP 设置中填写的 DNS 服务器地址）发出 DNS 请求。
    * 本地DNS服务器收到请求后查询缓存表格，如果找不到就依次查询根DNS服务器、顶级域名服务器、权威DNS服务器，返回该域名对应的IP地址。
* **协议栈封装**。应用程序（浏览器）通过调用 Socket 库，来委托协议栈工作。
    * 在 HTTP 传输数据之前，TCP三次握手建立一个TCP连接。运输层将http报文封装为TCP报文段。
    * 网络层将其封装为带有逻辑寻址头部的IP数据报。
    * 数据链路层将其封装为包含以太网mac地址的帧。通过 ARP 报文获取路由器的mac地址。
    * 帧被传递给物理层，网卡将数字比特流加上头部和尾部，调制成电或光信号发送出去。

* 数据包经过交换机、路由器等网络设备，最终被服务器接收。服务器层层剥除封装，读取http请求报文。服务器将网页封装在 **http响应报文** 里并发送给客户端。浏览器渲染后就出现了我们看到的网页。

+ 中心节点{.mindmap}
    + [1] 状态可见原则
    + [2] 环境贴切原则
    + [3] 用户可控原则
    + [4] 一致性原则
    + [5] 防错原则
    + [6] 易取原则
    + [7] 灵活高效原则
    + [8] 优美且简约原则
    + [9] 容错原则
    + [10] 人性化帮助原则


## wireshark基础设置与配置

### wireshark 基础选项
* **文件**（**file**）
    * 该选项主要负责数据包文件的打开、保存、合并；
    * 特定数据包的导出、打印等
* **编辑**（**edit**）
    * 数据包的查找、标记、忽略；
    * 对数据包时间显示格式的调整。
    * wireshark**配置文件**和偏好（首选项）的调整。
        * 首选项preference可以调整主窗口面板的各种显示（颜色、大小、列参数、主面板布局等）。
* **视图**（**view**）
    * 调整主页面布局。工具栏、状态栏、数据包显示细节等。
    * 设置数据包着色规则。
* **跳转**（**go**）
    * 主要使用快捷键快速跳转到特定数据包。
* **捕获**（**capture**）
    * 设置捕获数据包相关选项。
    * 保存已有的**过滤器表达式**。
* **分析**（**analyze**）
    * 设置**显示**数据包相关选项。
* **统计**（**statistics**）
    * 流量分析
* **电话**（**telephony**）
* **无线**（**wireless**）
    * 蓝牙设备、无线局域网流量
* **工具**（**tools**）
* **帮助**（**help**）
### Wireshark 首选项preference
`Edit -> Preference`
![Img](./FILES/01.%20数据包捕获与分析基础.md/img-20230303201123.png)
* **Appearance**（外观）：这些选项决定了 Wireshark 将如何显示数据。比如是否保存窗口位置、3 个主要窗口的布局、滚动条的摆放、Packet List 面板中列的摆放、显示捕获数据的字体、前景色和背景色等。

* **Capture**（捕获）：这些选项可以让你对于自己捕获数据包的方式进行特殊设定，比如你默认使用的设备、是否默认使用混杂模式、是否实时更新 Packet List面板等。

* **Filter Expressions**（过滤器表达式）：在之后的章节里我们将探讨 Wireshark 是如何让你基于设定标准去过滤流量的。这个部分中的选项可以让你生成和管理这些过滤器。

* **Name Resolutions**（名称解析）：通过这些设定，你可以开启 Wireshark 将地址（包括 MAC、网络以及传输名称解析）解析成更加容易分辨的名字这一功能，并且可以设定并发处理名称解析请求的最大数目。

* **Protocols**（协议）：这个部分中的选项可以让你调整关于捕捉和显示各种 Wireshark 解码数据包的功能。虽然并不是针对每一个协议都可以进行调整，但是有一些协议的选项可以进行更改。除非你有特殊的原因去修改这些选项，否则最好保持它们的默认值。

* **Statistics**（统计）：这一部分提供了 Wireshark 中统计功能的设定选项。在第 5 章节我们会对之进行更深入的学习。

* **Advanced**（高级）：在以上 6 个部分中没有做的设置会被归类到这里。通常这些设置只有 Wireshark 的高级用户才会去修改。

### wireshark 配置文件与配置方案
* 查看配置文件位置：`help -> about wireshark -> folders` 这里包含个人和全局设置目录。
![Img](./FILES/01.%20数据包捕获与分析基础.md/img-20230303200252.png)

* 查看配置方案列表：`edit -> Configuration Profiles` 或单击右下角profile
![Img](./FILES/01.%20数据包捕获与分析基础.md/img-20230303200354.png)


* 一个配置方案储存了下面的设置。
    * Preferences 参数选项。
    * Capture filters 捕获过滤器。
    * Display filters 显示过滤器。
    * Coloring rules 着色规则。
    * Disabled protocols 已禁用的协议。
    * Forced decodes 强制解码。
    * Recent settings 最近设置，比如窗格大小、菜单设置和列宽。
    * Protocol-specific tables 针对特定协议的表格，例如SNMP 用户和自定义HTTP 头。

### wireshark主窗口
主窗口有三个面板。
![Img](./FILES/01.%20数据包捕获与分析基础.md/img-20230304215323.png)

* **数据包列表**（packet list）
    * 显示了当前文件中的所有数据包的概况。包括数据包序号、被捕获时间、数据包源地址、协议等。各列选项可以右击或在 `edit -> preference` 进行增删调整。
* **数据包细节**（packet details）
    * 一个数据包在各层的所有细节。
* **数据包字节**（packet bytes）
    * 数据包在链路上传播的样子，十六进制表示。一位代表四个比特bit，两位代表一个字节byte。

## 数据包捕获
### 数据包嗅探
数据包分析，通常也被成为数据包嗅探或协议分析，指的是捕获和解析网络上在线传输的过程。

网络嗅探的目的是：
1. 了解网络特征 
2. 查看网络上的通信主体 
3. 确认谁或是那些应用在占用网络带宽 
4. 识别网络使用高峰时间 
5. 识别可能的攻击或恶意活动 
6. 寻找不安全以及滥用网络资源的应用

* 流量：通信过程中被传输的数据包。

* 可视范围：在数据包嗅探器中能够看到的通信流量的主机范围。

* 混杂模式：允许网卡能够查看到所有流经网络线路数据包的驱动模式。网卡将会把每一个它所看到的数据包都传递给主机cpu从而被嗅探器捕获分析，而无论数据包的目的地址是什么。

### 保存与导出
* 保存捕获的数据包：`file -> save as` 
* 保存**特定**的数据包：`file -> export specified packets`
    * 可以保存一定序号范围的数据包
    * 标记了的数据包
    * 经过滤器筛选的数据包
![Img](./FILES/01.%20数据包捕获与分析基础.md/img-20230303200221.png)
* 导出到不同格式的文件：`file -> export Packet -> dissections`

### 合并数据包
* 合并捕获文件：打开一个文件，选择 `file -> merge` ，选择待合并数据包即可合并。
    * 可以选择将待合并文件添加到原文件前、后或按时间戳排列合并。

### 设定捕获选项
设置捕获的具体条件。例如，用哪个网卡抓包、抓什么样的包、抓多大的包、怎么设置自动停止抓包、得到的文件如何储存等等。

* 设定捕获选项：`capture -> options `.该选项有三个标签页。
    * **输入**input：显示所有可以抓包的硬件接口和有关的基本信息。还可以在这里输入过滤表达式。
    * **输出**output：设置流量包的存储方式。
    * **选项**options：包括显示选项（display options）、名称解析选项（name resolution）、自动停止捕获选项（stop capture automatically after）等。

## 数据包分析

在处理大量数据包时，快速查找到特定条件的数据包是很重要的。

### 寻找数据包

* **找到符合特定条件的数据包**：`ctrl + F`
    * **Display Filter**：过滤表达式
    * **Hex value**：输入十六进制数进行搜索
    * **string**：输入字符串搜索
    * **Regular Expressions**：正则表达式


### 标记数据包
* **标记单个数据包**：右击单个数据包，选择`mark`
* **标记多个数据包**：按住 `shift` 选择一串，或按住ctrl逐个点击，再按`ctrl + m`进行标记。
    * 在标记的数据包之间前后切换：`shift + ctrl + N/B`

* **忽略数据包**：`ctrl + D`

### 打印数据包
* 打印数据包`file -> print`
    * 与 `export specified packets` 类似，可以选择特定的数据包进行打印。

### 设置时间显示格式和相对参考
有关时间的信息在网络分析中十分重要。

#### 时间显示格式（Time Display Format）
wireshark所捕获的数据包都会由操作系统赋予一个时间戳（timestamp）。我们可以选择它的**绝对**或**相对**时间。

* 调整**绝对时间**精度：`view -> time display format` 
* 调整**相对时间**参考：以一个数据包为参考，之后的数据包以此计算相对时间。
* 设置时间偏移：`edit -> time shift` 把数据包的部分时间戳整体偏移，以同步不同的数据源包。快捷键 `ctrl shift + t`。